{% extends 'base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">


{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {%block title%}
    <title>Task List</title>
    {%endblock%}
    <link rel="stylesheet" href="{% static 'css/tasks_list.css' %}">

</head>
<body>
    <br><br>
    <div class="container">
        <h1>Task List</h1>
        <div class="button-class">
        <button id="toggle-form-btn" class="add-task-button"><strong>+ </strong>Add Task</button>
        </div>
        <div id="create-form-container">
            <form method="POST" id="create-form">
                {% csrf_token %}
                {{form.as_p}}
                <div class="button-class">
                <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>        
        </div>
            <table id="task-list">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Due Time</th>
                        <th>Created At</th>
                        <th>Complete </th>
                        <th>Commands</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td id="task-{{task.pk}}" class="pinned-icon">
                            {% if task.pinned %}
                                <span><i class="fa-solid fa-thumbtack"></i></span>
                            {% endif %}
                            {{ task.task }}
                        </td>
                        <td>{{ task.task_due|date:"H:i" }}</td>
                        <td>{{ task.created_at }}</td>
                        <td>
                            <input type="checkbox" class="task-checkbox" data-task-pk="{{ task.pk }}" {% if task.complete %}checked{% endif %}>
                        </td>
                        <td>
                            <div class="dropdown" onclick="toggleDropdown(this)">
                                <i class="fas fa-ellipsis-v"></i>
                                <div class="dropdown-content">
                                    <a class="dropdown-item"><button class="delete-button" data-task-id="{{task.pk}}">Delete</button></a>
                                    {% if task.pinned %}
                                    <button class="pin-button btn btn-primary" data-task-id="{{ task.pk }}">Unpin task</button>
                                    {% else %}
                                    <button class="pin-button btn btn-primary" data-task-id="{{ task.pk }}">Pin task</button>
                                    {%endif%}

                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="modal" id="deleteModal">
            <div class="modal-content">
                <h2>Confirm Deletion</h2>
                <p>Are you sure you want to delete this task?</p>
                <button id="confirmDeleteBtn">Delete</button>
                <button id="cancelDeleteBtn">Cancel</button>
            </div>
        </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function toggleDropdown(dropdown) {
        dropdown.classList.toggle("active");
    }
</script>

<script>


    
    // Toggle form visibility
    $('#toggle-form-btn').click(function() {
        $('#create-form-container').toggle();
    });

    // AJAX form submission
    $(document).on('submit', '#create-form', function(e) {
        e.preventDefault();

        $.ajax({
            type: 'POST',
            url: "{% url 'create_task' %}",
            data: $(this).serialize(),
            success: function(response) {
                console.log("Task added successfully.");
                // Clear form fields
                $('#create-form')[0].reset();
                console.log("Form refreshed")
                // Hide the form
                $('#create-form-container').hide();
                console.log("Form hidden.")
                // Reload task list
                refreshTaskList();
                $('link[rel=stylesheet]').each(function() {
               var href = $(this).attr('href');
               $(this).attr('href', href + '?reload=' + new Date().getTime());
               });
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log('Error: ' + errorThrown);
            }
        });
    });

    // Function to refresh task list
    function refreshTaskList() {
        $.get("{% url 'tasks_list' %}", function(data) {
            var taskListBody = $('#task-list tbody');
            taskListBody.html($(data).find('tbody').html());
        });
    }

</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
            document.addEventListener("DOMContentLoaded", function() {
            const modal = document.getElementById("deleteModal");
            const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
            const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
            let taskIdToDelete;

            document.addEventListener("click", function(event) {
                const target = event.target;
                if (target.classList.contains("delete-button")) {
                    taskIdToDelete = target.dataset.taskId;
                    console.log("Deleting task id:", taskIdToDelete); 
                    modal.style.display = "block";
                }
            });

        cancelDeleteBtn.addEventListener("click", function() {
            modal.style.display = "none";
        });

        confirmDeleteBtn.addEventListener("click", function() {
            if (taskIdToDelete) {
                fetch(`/tasks_list/${taskIdToDelete}/delete/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    modal.style.display = "none";
                    window.location.reload();
                })
                console.log("Task deleted.")
                .catch(error => console.error("Error:", error));
            }
        });



        // Helper function to get the CSRF token from cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }
    });

</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const pinButtons = document.querySelectorAll('.pin-button');
        pinButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const taskId = button.dataset.taskId;
                try {
                    const response = await fetch(`/pin_task/${taskId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    console.log("Selected task id", {taskId})
                    const data = await response.json();
                    if (data.success) {
                        // Refresh the pinned task list after pinning
                        refreshPinnedTaskList();
                    }
                    console.log("Task pinned.");
                } catch (error) {
                    console.error('Error toggling pin:', error);
                }
            });
        });
    });

    function refreshPinnedTaskList() {
        $.get("{% url 'tasks_list' %}", function(data) {
            var taskListBody = $('#task-list tbody');
            taskListBody.html($(data).find('tbody').html());
        });
    }
</script>

</body>
</html>

{%endblock%}
